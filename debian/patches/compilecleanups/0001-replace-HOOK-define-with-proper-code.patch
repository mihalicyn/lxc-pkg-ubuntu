From c7e82333008330ae9edceac6b37676f3b79c8766 Mon Sep 17 00:00:00 2001
From: Serge Hallyn <serge.hallyn@ubuntu.com>
Date: Tue, 4 Sep 2012 13:57:39 -0500
Subject: [PATCH 1/4] replace HOOK define with proper code.

Signed-off-by: Serge Hallyn <serge.hallyn@ubuntu.com>
---
 src/lxc/conf.c  |   11 +++++++++--
 src/lxc/conf.h  |    6 ------
 src/lxc/start.c |   15 +++++++++++----
 3 files changed, 20 insertions(+), 12 deletions(-)

Index: lxc/src/lxc/conf.c
===================================================================
--- lxc.orig/src/lxc/conf.c	2012-09-04 14:53:59.000000000 -0500
+++ lxc/src/lxc/conf.c	2012-09-04 15:08:16.372453068 -0500
@@ -2192,7 +2192,10 @@
 		ERROR("failed to setup the cgroups for '%s'", name);
 		return -1;
 	}
-	HOOK(name, "mount", lxc_conf);
+	if (run_lxc_hooks(name, "mount", lxc_conf)) {
+		ERROR("failed to run mount hooks for container '%s'.", name);
+		return -1;
+	}
 
 	if (setup_console(&lxc_conf->rootfs, &lxc_conf->console, lxc_conf->ttydir)) {
 		ERROR("failed to setup the console for '%s'", name);
Index: lxc/src/lxc/conf.h
===================================================================
--- lxc.orig/src/lxc/conf.h	2012-09-04 14:53:59.000000000 -0500
+++ lxc/src/lxc/conf.h	2012-09-04 14:57:15.180477191 -0500
@@ -230,11 +230,6 @@
 };
 
 int run_lxc_hooks(const char *name, char *hook, struct lxc_conf *conf);
-#define HOOK(name, which, conf) \
-	do { \
-		int hookret = run_lxc_hooks(name, which, conf); \
-		if (hookret) return -1; \
-	} while (0);
 
 /*
  * Initialize the lxc configuration structure
Index: lxc/src/lxc/start.c
===================================================================
--- lxc.orig/src/lxc/start.c	2012-09-04 14:53:59.000000000 -0500
+++ lxc/src/lxc/start.c	2012-09-04 14:56:24.304479050 -0500
@@ -366,7 +366,10 @@
 		goto out_free_name;
 	}
 
-	HOOK(name, "pre-start", conf);
+	if (run_lxc_hooks(name, "pre-start", conf)) {
+		ERROR("failed to run pre-start hooks for container '%s'.", name);
+		goto out_aborting;
+	}
 
 	if (lxc_create_tty(name, conf)) {
 		ERROR("failed to create the ttys");
@@ -412,7 +415,8 @@
 	lxc_set_state(name, handler, STOPPING);
 	lxc_set_state(name, handler, STOPPED);
 
-	HOOK(name, "post-stop", handler->conf);
+	if (run_lxc_hooks(name, "post-stop", handler->conf))
+		ERROR("failed to run post-stop hooks for container '%s'.", name);
 
 	/* reset mask set by setup_signal_fd */
 	if (sigprocmask(SIG_SETMASK, &handler->oldmask, NULL))
@@ -596,9 +600,12 @@
 	if (lxc_seccomp_load(handler->conf) != 0)
 		goto out_warn_father;
 
-	close(handler->sigfd);
+	if (run_lxc_hooks(handler->name, "start", handler->conf)) {
+		ERROR("failed to run start hooks for container '%s'.", handler->name);
+		goto out_warn_father;
+	}
 
-	HOOK(handler->name, "start", handler->conf);
+	close(handler->sigfd);
 
 	/* after this call, we are in error because this
 	 * ops should not return as it execs */
