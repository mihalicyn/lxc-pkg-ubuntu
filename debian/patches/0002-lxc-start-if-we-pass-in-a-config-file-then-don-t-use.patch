From 4df7f012b9994ea54b1ad68176d8d45a57fa02f3 Mon Sep 17 00:00:00 2001
From: Serge Hallyn <serge.hallyn@ubuntu.com>
Date: Thu, 14 Nov 2013 12:48:41 -0600
Subject: [PATCH 1/1] lxc-start: if we pass in a config file, then don't use
 any loaded config
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

To do this, add a c->clear_config() helper to the api.

(this fixes the bug https://bugs.launchpad.net/bugs/1251352)

Signed-off-by: Serge Hallyn <serge.hallyn@ubuntu.com>
Acked-by: St√©phane Graber <stgraber@ubuntu.com>
---
 src/lxc/lxc_start.c    |  1 +
 src/lxc/lxccontainer.c | 16 +++++++++++-----
 src/lxc/lxccontainer.h |  2 ++
 3 files changed, 14 insertions(+), 5 deletions(-)

Index: lxc/src/lxc/lxc_start.c
===================================================================
--- lxc.orig/src/lxc/lxc_start.c	2013-11-14 14:18:56.113561002 -0600
+++ lxc/src/lxc/lxc_start.c	2013-11-14 14:18:56.093561002 -0600
@@ -187,6 +187,7 @@
 			ERROR("Failed to create lxc_container");
 			return err;
 		}
+		c->clear_config(c);
 		if (!c->load_config(c, rcfile)) {
 			ERROR("Failed to load rcfile");
 			lxc_container_put(c);
Index: lxc/src/lxc/lxccontainer.c
===================================================================
--- lxc.orig/src/lxc/lxccontainer.c	2013-11-14 14:18:56.113561002 -0600
+++ lxc/src/lxc/lxccontainer.c	2013-11-14 14:18:56.093561002 -0600
@@ -987,6 +987,14 @@
 	return true;
 }
 
+static void lxcapi_clear_config(struct lxc_container *c)
+{
+	if (c && c->lxc_conf) {
+		lxc_conf_free(c->lxc_conf);
+		c->lxc_conf = NULL;
+	}
+}
+
 static bool lxcapi_destroy(struct lxc_container *c);
 /*
  * lxcapi_create:
@@ -1085,9 +1093,7 @@
 
 	// now clear out the lxc_conf we have, reload from the created
 	// container
-	if (c->lxc_conf)
-		lxc_conf_free(c->lxc_conf);
-	c->lxc_conf = NULL;
+	lxcapi_clear_config(c);
 
 	if (!prepend_lxc_header(c->configfile, tpath, argv)) {
 		ERROR("Error prepending header to configuration file");
@@ -2694,8 +2700,7 @@
 	if (ongoing_create(c) == 2) {
 		ERROR("Error: %s creation was not completed", c->name);
 		lxcapi_destroy(c);
-		lxc_conf_free(c->lxc_conf);
-		c->lxc_conf = NULL;
+		lxcapi_clear_config(c);
 	}
 
 	// assign the member functions
@@ -2723,6 +2728,7 @@
 	c->createl = lxcapi_createl;
 	c->shutdown = lxcapi_shutdown;
 	c->reboot = lxcapi_reboot;
+	c->clear_config = lxcapi_clear_config;
 	c->clear_config_item = lxcapi_clear_config_item;
 	c->get_config_item = lxcapi_get_config_item;
 	c->get_cgroup_item = lxcapi_get_cgroup_item;
Index: lxc/src/lxc/lxccontainer.h
===================================================================
--- lxc.orig/src/lxc/lxccontainer.h	2013-11-14 14:18:56.113561002 -0600
+++ lxc/src/lxc/lxccontainer.h	2013-11-14 14:18:56.093561002 -0600
@@ -85,6 +85,8 @@
 	bool (*reboot)(struct lxc_container *c);
 	/* send SIGPWR.  if timeout is not 0 or -1, do a hard stop after timeout seconds */
 	bool (*shutdown)(struct lxc_container *c, int timeout);
+	/* completely clear a configuration */
+	void (*clear_config)(struct lxc_container *c);
 	/* clear all network or capability items in the in-memory configuration */
 	bool (*clear_config_item)(struct lxc_container *c, const char *key);
 	/* print a config item to a in-memory string allocated by the caller.  Return
