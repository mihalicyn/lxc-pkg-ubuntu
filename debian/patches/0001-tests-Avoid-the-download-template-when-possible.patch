From 05c2acbedc911b825008a2c98a29d1a250fd2b64 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@ubuntu.com>
Date: Fri, 13 Jun 2014 17:45:26 -0400
Subject: tests: Avoid the download template when possible
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The use of the download template with an hardcoded --arch=amd64 in aa.c
was causing test failures on any platform incapable of running amd64
binaries.

This wasn't noticed in the CI environment as we run the tests within
containers on an amd64 kernel but this caused failures on the Ubuntu CI
environment.

Instead, let's use the busybox template, tweaking the configuration when
needed to match the needs of the testcase.

Signed-off-by: St√©phane Graber <stgraber@ubuntu.com>
Acked-by: Serge E. Hallyn <serge.hallyn@ubuntu.com>
---
 src/tests/aa.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/tests/aa.c b/src/tests/aa.c
index a8ff691..2be472d 100644
--- a/src/tests/aa.c
+++ b/src/tests/aa.c
@@ -164,10 +164,16 @@ int main(int argc, char *argv[])
 		goto err;
 	}
 	c->save_config(c, NULL);
-	if (!c->createl(c, "download", NULL, NULL, 0, "-d", "ubuntu", "-r", "trusty", "-a", "amd64", NULL)) {
+	if (!c->createl(c, "busybox", NULL, NULL, 0, NULL)) {
 		fprintf(stderr, "%s: %d: failed to create container\n", __FILE__, __LINE__);
 		goto err;
 	}
+
+	c->clear_config_item(c, "lxc.mount.auto");
+	c->set_config_item(c, "lxc.mount.entry", "proc proc proc");
+	c->set_config_item(c, "lxc.mount.entry", "sysfs sys sysfs");
+	c->save_config(c, NULL);
+
 	c->want_daemonize(c, true);
 	if (!c->startl(c, 0, NULL)) {
 		fprintf(stderr, "Error starting container");
